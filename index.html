<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Dashboard Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Loading spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Modal do Consultor IA -->
    <div id="aiAdvisorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                    <i class="fas fa-sparkles text-purple-500"></i> Consultor IA
                </h2>
                <button onclick="closeAiAdvisorModal()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="aiAdvisorContent" class="text-gray-700 min-h-[100px] flex flex-col justify-center text-sm leading-relaxed">
                <!-- Conteúdo gerado pela IA -->
            </div>
        </div>
    </div>

    <!-- Pop-up de Alerta Customizado -->
    <div id="customAlert" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm modal-enter text-center">
            <div class="text-orange-500 mb-4"><i class="fas fa-exclamation-circle text-5xl"></i></div>
            <p id="customAlertMessage" class="text-gray-700 mb-6"></p>
            <button onclick="closeCustomAlert()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-lg font-medium transition">OK</button>
        </div>
    </div>

    <!-- Pop-up de Confirmação Customizado -->
    <div id="customConfirm" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm modal-enter text-center">
            <div class="text-red-500 mb-4"><i class="fas fa-question-circle text-5xl"></i></div>
            <p id="customConfirmMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button onclick="closeCustomConfirm()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium transition">Cancelar</button>
                <button id="customConfirmBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Barra de Navegação -->
    <nav class="bg-white shadow-sm border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2 text-blue-600">
            <i class="fas fa-wallet text-2xl"></i>
            <h1 class="text-xl font-bold">Finanças<span class="text-gray-800">Pro</span></h1>
        </div>
        <button onclick="openAiAdvisorModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-md flex items-center gap-2 text-sm">
            ✨ Consultor IA
        </button>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-32">
        
        <!-- Indicador de Estado -->
        <div id="connectionStatus" class="mb-6 text-sm flex items-center gap-2 p-3 rounded-lg border">
            <!-- Preenchido via JavaScript -->
        </div>

        <!-- Saldo Atual (Total Histórico) -->
        <div class="mb-6">
            <div class="glass-card p-6 sm:p-8 border-t-4 border-purple-500 bg-gradient-to-br from-white to-purple-50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-gray-600 font-semibold text-sm sm:text-base uppercase tracking-wider">Saldo Atual (Total)</h3>
                    <div class="p-3 bg-purple-100 rounded-full text-purple-600"><i class="fas fa-wallet text-xl"></i></div>
                </div>
                <h2 class="text-4xl sm:text-5xl font-bold text-gray-800" id="overallBalance">R$ 0,00</h2>
            </div>
        </div>

        <!-- Cartões de Resumo do Mês -->
        <div class="grid grid-cols-3 gap-2 sm:gap-6 mb-8">
            <div class="glass-card p-3 sm:p-6 border-t-4 border-blue-500 flex flex-col justify-between">
                <div class="flex justify-between items-center mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm text-gray-500 font-medium truncate pr-1">Saldo do Mês</h3>
                    <div class="hidden sm:flex p-2 bg-blue-100 rounded-full text-blue-600"><i class="fas fa-dollar-sign"></i></div>
                </div>
                <h2 class="text-sm sm:text-3xl font-bold truncate" id="totalBalance">R$ 0,00</h2>
            </div>
            <div class="glass-card p-3 sm:p-6 border-t-4 border-green-500 flex flex-col justify-between">
                <div class="flex justify-between items-center mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm text-gray-500 font-medium truncate pr-1">Entradas</h3>
                    <div class="hidden sm:flex p-2 bg-green-100 rounded-full text-green-600"><i class="fas fa-arrow-up"></i></div>
                </div>
                <h2 class="text-sm sm:text-3xl font-bold text-green-600 truncate" id="totalIncome">R$ 0,00</h2>
            </div>
            <div class="glass-card p-3 sm:p-6 border-t-4 border-red-500 flex flex-col justify-between">
                <div class="flex justify-between items-center mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm text-gray-500 font-medium truncate pr-1">Saídas</h3>
                    <div class="hidden sm:flex p-2 bg-red-100 rounded-full text-red-600"><i class="fas fa-arrow-down"></i></div>
                </div>
                <h2 class="text-sm sm:text-3xl font-bold text-red-600 truncate" id="totalExpense">R$ 0,00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna Esquerda: Formulário -->
            <div class="space-y-8">
                <!-- Formulário de Nova Transação -->
                <div class="glass-card p-6 relative">
                    <!-- Overlay de Loading -->
                    <div id="batchLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-80 z-10 hidden flex-col items-center justify-center rounded-xl">
                        <div class="loader border-t-blue-600 mb-2" style="display: block; width: 40px; height: 40px; border-width: 4px;"></div>
                        <p id="batchLoadingText" class="text-blue-600 font-medium">Processando...</p>
                    </div>

                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold" id="formTitle">Nova Transação</h3>
                        <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="text-sm text-red-500 hover:text-red-700 hidden">
                            Cancelar Edição
                        </button>
                    </div>
                    
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                            <input type="text" id="desc" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Salário, Aluguel, Supermercado...">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor Unitário</label>
                                <input type="number" id="amount" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                                <select id="type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="expense">Saída</option>
                                    <option value="income">Entrada</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                                </div>
                                <select id="category" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <!-- Preenchido via JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data Inicial</label>
                                <input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>

                        <!-- Opção de Repetição (Parcelas) -->
                        <div id="recurringWrapper" class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="isRecurring" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">Repetir transação (Mensal / Parcelas)</span>
                            </label>
                            
                            <div id="recurringOptions" class="hidden pl-6 pt-2 border-t border-gray-200 mt-2">
                                <label class="block text-sm text-gray-600 mb-1">Número de ocorrências (Meses):</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="installmentsCount" min="2" max="120" value="2" class="w-24 p-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-center">
                                    <span class="text-xs text-gray-500">Ex: 12 para um ano.</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition flex justify-center items-center gap-2">
                            <span id="submitBtnText">Adicionar Transação</span>
                            <div id="submitLoader" class="loader border-t-white"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Coluna Direita: Lista de Transações -->
            <div class="lg:col-span-2">
                <div class="glass-card p-6 h-full">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3 gap-3">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <h3 class="text-lg font-bold">Histórico Recente</h3>
                            <select id="monthFilter" class="bg-blue-50 border border-blue-200 text-blue-800 text-sm font-semibold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 outline-none hidden transition-all cursor-pointer">
                                <!-- Preenchido via JS apenas com meses que possuem dados -->
                            </select>
                        </div>
                        <div id="tableLoader" class="loader border-t-blue-600" style="display: block;"></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-gray-500 text-sm border-b">
                                    <th class="pb-3 font-medium">Data</th>
                                    <th class="pb-3 font-medium">Descrição</th>
                                    <th class="pb-3 font-medium">Categoria</th>
                                    <th class="pb-3 font-medium text-right">Valor</th>
                                    <th class="pb-3 font-medium text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactionList" class="text-sm">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Estado Vazio -->
                    <div id="emptyState" class="text-center py-10 hidden">
                        <i class="fas fa-receipt text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Nenhuma transação registrada neste mês.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Adição Mágica Fixa no Rodapé -->
    <div class="fixed bottom-0 left-0 right-0 z-40 p-4 pointer-events-none">
        <div class="max-w-7xl mx-auto pointer-events-auto bg-white rounded-xl shadow-[0_-4px_15px_rgba(0,0,0,0.1)] border border-purple-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 sm:px-6 flex flex-col sm:flex-row items-center gap-4">
                <div class="flex-shrink-0 flex items-center gap-2 text-purple-800 font-bold whitespace-nowrap">
                    <i class="fas fa-sparkles"></i> Adição Mágica
                </div>
                <div class="w-full flex gap-2">
                    <input type="text" id="magicInput" placeholder="Ex: Gastei 150 no mercado hoje de manhã..." class="w-full p-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-white text-sm">
                    <button onclick="magicFill()" id="magicBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition flex items-center gap-2 font-medium whitespace-nowrap">
                        <span id="magicBtnText">Adicionar</span>
                        <div id="magicLoader" class="loader border-t-white w-4 h-4 hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAÇÃO DO GOOGLE SHEETS
        // ==========================================
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbzWUDDgswIVJp7I3NYuif93Q7yQYm2JEKNxLGSaiLBetXweOGbF30SaHyrG34ee_ayi/exec'; 

        // ==========================================
        // ESTADO DA APLICAÇÃO
        // ==========================================
        let transactions = [];
        let editingId = null; 
        
        let currentMonthFilter = new Date().toISOString().slice(0, 7); // Mês atual YYYY-MM
        const monthFilterEl = document.getElementById('monthFilter');
        
        const defaultCategories = [
            "Salário", "Renda Extra", "Investimentos", "Alimentação", 
            "Supermercado", "Transporte", "Combustível", "Moradia", 
            "Contas Fixas", "Lazer", "Saúde", "Farmácia", "Educação", 
            "Vestuário", "Pets", "Viagens", "Impostos", "Outros"
        ];
        let categories = JSON.parse(localStorage.getItem('finance_categories')) || defaultCategories;

        const form = document.getElementById('transactionForm');
        const listEl = document.getElementById('transactionList');
        const emptyState = document.getElementById('emptyState');
        const submitLoader = document.getElementById('submitLoader');
        const tableLoader = document.getElementById('tableLoader');
        const categorySelect = document.getElementById('category');

        document.getElementById('date').valueAsDate = new Date();

        document.getElementById('isRecurring').addEventListener('change', (e) => {
            const options = document.getElementById('recurringOptions');
            if(e.target.checked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        });

        monthFilterEl.addEventListener('change', (e) => {
            currentMonthFilter = e.target.value;
            updateUI();
        });

        // ==========================================
        // SISTEMA DE ALERTAS / CONFIRMAÇÕES (UI)
        // ==========================================
        function showCustomAlert(msg) {
            document.getElementById('customAlertMessage').innerText = msg;
            document.getElementById('customAlert').classList.remove('hidden');
        }

        function closeCustomAlert() {
            document.getElementById('customAlert').classList.add('hidden');
        }

        let currentConfirmCallback = null;
        function showCustomConfirm(msg, callback) {
            document.getElementById('customConfirmMessage').innerText = msg;
            currentConfirmCallback = callback;
            document.getElementById('customConfirm').classList.remove('hidden');
        }

        function closeCustomConfirm() {
            document.getElementById('customConfirm').classList.add('hidden');
            currentConfirmCallback = null;
        }

        document.getElementById('customConfirmBtn').addEventListener('click', () => {
            if (currentConfirmCallback) currentConfirmCallback();
            closeCustomConfirm();
        });


        // ==========================================
        // INICIALIZAÇÃO E CATEGORIAS
        // ==========================================
        async function init() {
            updateConnectionStatus();
            renderCategoryOptions();
            await fetchData();
        }

        function isUrlConfigured() {
            return GOOGLE_SHEETS_API_URL && GOOGLE_SHEETS_API_URL.startsWith('https://script.google.com/');
        }

        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (isUrlConfigured()) {
                statusDiv.className = 'mb-6 text-sm flex items-center gap-2 text-green-700 bg-green-50 p-3 rounded-lg border border-green-200';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i><span>Conectado ao Google Sheets. Seus dados estão sendo salvos na nuvem em tempo real.</span>';
            } else {
                statusDiv.className = 'mb-6 text-sm flex items-center gap-2 text-orange-700 bg-orange-50 p-3 rounded-lg border border-orange-200';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span><strong>Aviso:</strong> A URL do Google Sheets não foi configurada. Dados salvos apenas no navegador. Edite o código para conectar.</span>';
            }
        }

        function renderCategoryOptions() {
            categorySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        // ==========================================
        // COMUNICAÇÃO COM BD (READ, CREATE, DELETE)
        // ==========================================
        async function fetchData() {
            tableLoader.style.display = 'block';
            if (isUrlConfigured()) {
                try {
                    const response = await fetch(GOOGLE_SHEETS_API_URL);
                    const result = await response.json();
                    if(result.status === 'success') { transactions = result.data; }
                } catch (error) {
                    console.error("Erro:", error);
                    showCustomAlert("Erro ao carregar dados da planilha.");
                }
            } else {
                const localData = localStorage.getItem('finance_transactions');
                transactions = localData ? JSON.parse(localData) : [];
            }
            tableLoader.style.display = 'none';
            updateUI();
        }

        async function saveTransactionToDB(transaction) {
            if (isUrlConfigured()) {
                try {
                    const response = await fetch(GOOGLE_SHEETS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'add', data: transaction })
                    });
                    const result = await response.json();
                    return result.status === 'success';
                } catch (error) { return false; }
            } else {
                localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                return true;
            }
        }

        async function deleteTransactionFromDB(id) {
            if (isUrlConfigured()) {
                try {
                    const response = await fetch(GOOGLE_SHEETS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete', id: id })
                    });
                    const result = await response.json();
                    return result.status === 'success';
                } catch (error) { return false; }
            } else {
                localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                return true;
            }
        }

        // ==========================================
        // LÓGICA DE FORMULÁRIO (ADD / EDIT / PARCELAS)
        // ==========================================
        
        function addMonths(dateString, monthsToAdd) {
            const d = new Date(dateString + 'T12:00:00'); 
            d.setMonth(d.getMonth() + monthsToAdd);
            return d.toISOString().split('T')[0];
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const descInput = document.getElementById('desc').value;
            const amountInput = parseFloat(document.getElementById('amount').value);
            const typeInput = document.getElementById('type').value;
            const categoryInput = document.getElementById('category').value;
            const dateInput = document.getElementById('date').value;
            
            const isRecurring = document.getElementById('isRecurring').checked;
            const installments = isRecurring ? parseInt(document.getElementById('installmentsCount').value) : 1;

            if (editingId) {
                submitLoader.style.display = 'inline-block';
                const updatedTransaction = {
                    id: editingId, 
                    desc: descInput, amount: amountInput, type: typeInput, category: categoryInput, date: dateInput
                };

                const index = transactions.findIndex(t => t.id === editingId);
                const oldBackup = transactions[index];
                transactions[index] = updatedTransaction;
                
                currentMonthFilter = String(dateInput).slice(0, 7); // Força a visualização do mês da transação
                updateUI();

                const delSuccess = await deleteTransactionFromDB(editingId);
                let saveSuccess = false;
                if(delSuccess) { saveSuccess = await saveTransactionToDB(updatedTransaction); }

                if(!saveSuccess) {
                    transactions[index] = oldBackup; 
                    updateUI();
                    showCustomAlert("Falha ao editar a transação na base de dados.");
                }

                cancelEdit();
                submitLoader.style.display = 'none';
                return;
            }

            const overlay = document.getElementById('batchLoadingOverlay');
            const overlayText = document.getElementById('batchLoadingText');
            
            if(installments > 1) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                submitLoader.style.display = 'inline-block';
            }

            let allSuccess = true;

            for(let i = 0; i < installments; i++) {
                if(installments > 1) overlayText.innerText = `Salvando parcela ${i+1} de ${installments}...`;

                const iterationDate = addMonths(dateInput, i);
                const descSuffix = installments > 1 ? ` (${i+1}/${installments})` : '';

                const newTransaction = {
                    id: Date.now().toString() + '-' + i, 
                    desc: descInput + descSuffix,
                    amount: amountInput,
                    type: typeInput,
                    category: categoryInput,
                    date: iterationDate
                };

                transactions.push(newTransaction);
                currentMonthFilter = String(newTransaction.date).slice(0, 7); // Move filtro para a transação adicionada
                updateUI(); 

                const success = await saveTransactionToDB(newTransaction);
                if(!success) {
                    allSuccess = false;
                    transactions = transactions.filter(t => t.id !== newTransaction.id);
                    updateUI();
                    break; 
                }
            }

            if(!allSuccess) {
                showCustomAlert("Ocorreu um erro ao salvar algumas transações. Verifique sua conexão.");
            } else {
                form.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('recurringOptions').classList.add('hidden');
            }

            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            submitLoader.style.display = 'none';
        });

        // ==========================================
        // LÓGICA DE EDIÇÃO E EXCLUSÃO
        // ==========================================
        function startEdit(id) {
            const t = transactions.find(t => t.id === id);
            if(!t) return;

            editingId = id;
            document.getElementById('desc').value = t.desc;
            document.getElementById('amount').value = t.amount;
            document.getElementById('type').value = t.type;
            document.getElementById('category').value = t.category;
            document.getElementById('date').value = String(t.date).split('T')[0];

            document.getElementById('formTitle').innerText = "Editar Transação";
            document.getElementById('submitBtnText').innerText = "Atualizar Transação";
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('recurringWrapper').classList.add('hidden'); 

            document.getElementById('transactionForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            form.reset();
            document.getElementById('date').valueAsDate = new Date();
            
            document.getElementById('formTitle').innerText = "Nova Transação";
            document.getElementById('submitBtnText').innerText = "Adicionar Transação";
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('recurringWrapper').classList.remove('hidden');
        }

        function removeTransaction(id) {
            showCustomConfirm("Tem certeza que deseja excluir esta transação?", async () => {
                const transactionIndex = transactions.findIndex(t => t.id === id);
                const transactionBackup = transactions[transactionIndex];
                transactions.splice(transactionIndex, 1);
                updateUI();

                const success = await deleteTransactionFromDB(id);
                if(!success) {
                    transactions.splice(transactionIndex, 0, transactionBackup);
                    updateUI();
                    showCustomAlert("Falha ao excluir a transação.");
                }
            });
        }

        // ==========================================
        // ATUALIZAÇÃO DA INTERFACE (UI)
        // ==========================================
        function getFilteredTransactions() {
            return transactions.filter(t => String(t.date).startsWith(currentMonthFilter));
        }

        function formatMonthName(yyyymm) {
            if (!yyyymm) return '';
            const [year, month] = yyyymm.split('-');
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${months[parseInt(month, 10) - 1]} de ${year}`;
        }

        function updateMonthOptions() {
            // Pega apenas os meses (YYYY-MM) únicos onde há transações
            const uniqueMonths = [...new Set(transactions.map(t => String(t.date).slice(0, 7)))];
            uniqueMonths.sort((a, b) => b.localeCompare(a)); // Ordem decrescente

            if (uniqueMonths.length === 0) {
                monthFilterEl.classList.add('hidden');
                return;
            }

            // Se o mês selecionado não tem dados, muda pro mais recente que tenha
            if (!uniqueMonths.includes(currentMonthFilter)) {
                currentMonthFilter = uniqueMonths[0];
            }

            monthFilterEl.innerHTML = '';
            uniqueMonths.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = formatMonthName(m);
                if (m === currentMonthFilter) option.selected = true;
                monthFilterEl.appendChild(option);
            });
            monthFilterEl.classList.remove('hidden');
        }

        function updateUI() {
            updateMonthOptions();
            renderTable();
            updateSummary();
        }

        function renderTable() {
            listEl.innerHTML = '';
            const filteredData = getFilteredTransactions();
            
            if (filteredData.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                
                const sorted = [...filteredData].sort((a, b) => new Date(b.date) - new Date(a.date));

                sorted.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50 transition';
                    
                    const isIncome = t.type === 'income';
                    const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                    const sign = isIncome ? '+' : '-';
                    
                    const dateStr = String(t.date).split('T')[0];
                    const formattedDate = new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR');
                    const formattedAmount = t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    tr.innerHTML = `
                        <td class="py-3">${formattedDate}</td>
                        <td class="py-3 font-medium">${t.desc}</td>
                        <td class="py-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${t.category}</span></td>
                        <td class="py-3 text-right font-semibold ${amountClass}">${sign} ${formattedAmount}</td>
                        <td class="py-3 text-center">
                            <div class="flex justify-center gap-3">
                                <button onclick="startEdit('${t.id}')" class="text-blue-400 hover:text-blue-600 transition" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="removeTransaction('${t.id}')" class="text-red-400 hover:text-red-600 transition" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    listEl.appendChild(tr);
                });
            }
        }

        function updateSummary() {
            // --- 1. Cálculo do Saldo Total (Histórico Completo) ---
            const overallIncome = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const overallExpense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const overallBalance = overallIncome - overallExpense;

            const overallBalanceEl = document.getElementById('overallBalance');
            overallBalanceEl.innerText = overallBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            if(overallBalance < 0) { 
                overallBalanceEl.classList.add('text-red-600'); 
                overallBalanceEl.classList.remove('text-gray-800'); 
            } else { 
                overallBalanceEl.classList.remove('text-red-600'); 
                overallBalanceEl.classList.add('text-gray-800'); 
            }

            // --- 2. Cálculo do Resumo do Mês (Filtrado) ---
            const filteredData = getFilteredTransactions();
            const income = filteredData.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = filteredData.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;

            document.getElementById('totalIncome').innerText = income.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalExpense').innerText = expense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalBalance').innerText = balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            const balanceEl = document.getElementById('totalBalance');
            if(balance < 0) { balanceEl.classList.add('text-red-600'); } 
            else { balanceEl.classList.remove('text-red-600'); }
        }

        // ==========================================
        // INTEGRAÇÃO COM GEMINI API (IA)
        // ==========================================
        const apiKey = "AIzaSyCWAtLb_SjIm-kXeqSjZ9mAQt7uwOBcsV8"; // ⚠️ ATENÇÃO: COLE SUA CHAVE DA API AQUI DENTRO DAS ASPAS
        
        async function fetchGeminiWithRetry(payload, maxRetries = 5) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        async function magicFill() {
            const inputEl = document.getElementById('magicInput');
            const btnEl = document.getElementById('magicBtn');
            const btnTextEl = document.getElementById('magicBtnText');
            const loaderEl = document.getElementById('magicLoader');
            const text = inputEl.value.trim();
            
            if (!text) return;

            btnEl.disabled = true;
            btnTextEl.innerText = "Pensando...";
            loaderEl.classList.remove('hidden');
            loaderEl.style.display = 'inline-block';

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: {
                    parts: [{ 
                        text: `Você é um assistente financeiro. Sua tarefa é extrair os dados da transação financeira descrita.
                        OBRIGATÓRIO: A categoria (category) DEVE ser ESCOLHIDA ESTRITAMENTE DESTA LISTA: [${categories.join(', ')}]. 
                        Em hipótese alguma invente, traduza ou crie uma categoria nova. Escolha a opção da lista que faça mais sentido para a transação.
                        Hoje é ${new Date().toLocaleDateString('pt-BR')}. Data deve ser YYYY-MM-DD.
                        O tipo (type) deve ser estritamente 'income' (entradas/ganhos) ou 'expense' (saídas/gastos).`
                    }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            desc: { type: "STRING" },
                            amount: { type: "NUMBER" },
                            type: { type: "STRING" },
                            category: { type: "STRING" },
                            date: { type: "STRING" }
                        },
                        required: ["desc", "amount", "type", "category", "date"]
                    }
                }
            };

            try {
                const result = await fetchGeminiWithRetry(payload);
                const jsonText = result.candidates[0].content.parts[0].text;
                const data = JSON.parse(jsonText);

                // Garante que a IA não burlou a regra; se sim, joga para "Outros"
                if (!categories.includes(data.category)) {
                    data.category = "Outros";
                }
                
                const newTransaction = {
                    id: Date.now().toString() + '-magic',
                    desc: data.desc || 'Transação Mágica',
                    amount: data.amount || 0,
                    type: data.type || 'expense',
                    category: data.category,
                    date: data.date || new Date().toISOString().split('T')[0]
                };

                transactions.push(newTransaction);
                currentMonthFilter = String(newTransaction.date).slice(0, 7); // Força a tela a mostrar o mês inserido
                updateUI();
                inputEl.value = '';
                
                btnEl.classList.replace('bg-purple-600', 'bg-green-500');
                btnEl.classList.replace('hover:bg-purple-700', 'hover:bg-green-600');
                btnTextEl.innerHTML = '<i class="fas fa-check"></i> Adicionado!';
                
                setTimeout(() => {
                    btnEl.classList.replace('bg-green-500', 'bg-purple-600');
                    btnEl.classList.replace('hover:bg-green-600', 'hover:bg-purple-700');
                    btnTextEl.innerText = 'Adicionar';
                }, 2000);

                const success = await saveTransactionToDB(newTransaction);
                if(!success) {
                    transactions = transactions.filter(t => t.id !== newTransaction.id);
                    updateUI();
                    showCustomAlert("Ocorreu um erro ao salvar a transação mágica na base de dados.");
                }

            } catch (error) {
                showCustomAlert("Erro ao processar a entrada mágica. Tente novamente.");
                btnTextEl.innerText = 'Adicionar';
            } finally {
                btnEl.disabled = false;
                loaderEl.style.display = 'none';
                loaderEl.classList.add('hidden');
            }
        }

        function openAiAdvisorModal() {
            document.getElementById('aiAdvisorModal').classList.remove('hidden');
            document.getElementById('aiAdvisorContent').innerHTML = `
                <div class="flex items-center justify-center gap-3 py-8">
                    <div class="loader border-t-purple-600" style="display: block;"></div>
                    <span class="text-purple-700 font-medium">A IA está analisando suas finanças...</span>
                </div>
            `;
            generateFinancialAdvice();
        }

        function closeAiAdvisorModal() {
            document.getElementById('aiAdvisorModal').classList.add('hidden');
        }

        async function generateFinancialAdvice() {
            const filteredData = getFilteredTransactions();
            
            if (filteredData.length === 0) {
                document.getElementById('aiAdvisorContent').innerHTML = '<p class="text-gray-600 text-center py-4">Não há transações neste mês para eu poder analisar!</p>';
                return;
            }

            const income = filteredData.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = filteredData.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const categoriesMap = {};
            filteredData.filter(t => t.type === 'expense').forEach(t => {
                categoriesMap[t.category] = (categoriesMap[t.category] || 0) + t.amount;
            });

            const summaryText = `Resumo de ${formatMonthName(currentMonthFilter)} - Saldo: ${income - expense}. Entradas: ${income}. Saídas: ${expense}. Gastos por categoria: ${JSON.stringify(categoriesMap)}`;

            const payload = {
                contents: [{ parts: [{ text: summaryText }] }],
                systemInstruction: {
                    parts: [{ 
                        text: "Você é um consultor financeiro inteligente, encorajador e direto. Analise o resumo financeiro do usuário referente ao mês vigente e dê 1 insight principal e 1 dica prática de contenção ou investimento. Use formatação HTML básica (<b>, <ul>, <li>, <br>) para deixar a resposta bonita. Mantenha a resposta curta (max 3 parágrafos). Fale em Português do Brasil de forma amigável."
                    }]
                }
            };

            try {
                const result = await fetchGeminiWithRetry(payload);
                const adviceHtml = result.candidates[0].content.parts[0].text;
                document.getElementById('aiAdvisorContent').innerHTML = adviceHtml;
            } catch (error) {
                document.getElementById('aiAdvisorContent').innerHTML = '<p class="text-red-500 text-center py-4">Ocorreu um erro ao consultar a IA. Tente novamente mais tarde.</p>';
            }
        }

        // Inicia a aplicação
        init();

    </script>
</body>
</html>
